# 需求
做一个能量提醒的周五行：
1. 通过某个接口工具获取到本周和下周的日历五行；
2. 根据两周的五行、个人的八字排盘总结本周总体运势、关键事件和注意事项，一句话概况本周到下周的变化。

◼️6.9-6.15的五行能量
◼️当下是乙巳年壬午月
	
6.9 周一 己酉日，土金旺，火旺的月份，金是被牵制的。
	
6.10 周二 庚戌日，土金旺，月日地支午戌合火，利部分喜火。
	
6.11 周三 辛亥日，金水旺，削弱火的能量，忌金水的多加注意。
	
6.12 周四 壬子日，水旺，地支子午冲注意人际关系，情绪起伏。
	
6.13 周五 癸丑日，水土旺，水土混杂人容易糊涂 脑子不清楚，谨慎做决定。
	
6.14 周六 甲寅日，木旺，地支有申的，主义寅巳申三邢方面的人际关系 健康 交通安全。
	
6.15 周日 乙卯日，木旺，但是地支午卯相破，利喜木的，喜火是喜忧参半。
	
本周的五行能量主要是从土金过渡到金水再到木。


### 命主信息
- 名字
刘瑞
- 性别
女
- 胎身命
否
- 真太阳时生辰
1999年11月22日（十月十五）21：47
- 当前所在城市
成都
- 四柱
己卯 乙亥 戊寅 癸亥
- 大运
> 起运：出生后5年0月0日0时上大运
> 交运：逢甲、己年 立冬后15天11小时 交大运

# prompt

## 任务目标
根据两周的五行、个人的八字排盘总结本周总体运势、关键事件和注意事项，一句话概况本周到下周的变化。

## 输出格式
### **<命主名称>专属五行能量周报<周一时间 - 周日时间>**

---

#### **命盘解读**

* **日主:**
    * 【规则：提取八字日柱的天干作为日主。简要描述该天干的基本特质，例如：甲木为阳木，象征大树，有领导力；戊土为阳土，象征大地，稳重诚信等。】

* **命盘格局:**
    * 【规则：综合分析八字全局中金、木、水、火、土五行的力量对比，判断日主的强弱状态（如：身强、身弱、从强、从弱等）。并概括命盘的核心特征，例如：“食伤生财”、“官印相生”、“身弱财官旺”等。】

* **喜用神:**
    * 【规则：根据命盘的平衡需求，确定对日主最有利的五行。通常身弱者喜“印星”（生助日主的五行）和“比劫”（与日主相同的五行）。在此明确指出最喜和次喜的五行及其对应的十神。】

* **忌神:**
    * 【规则：根据命盘的平衡需求，确定对日主不利的五行。通常与喜用神相反。在此明确指出最忌和次忌的五行及其对应的十神。】

---

#### **流日分析**

* **当下大环境:**
    * 【规则：列出当前所在的流年、流月干支。结合命主的喜忌，简要分析当年、当月的大环境对命主的总体影响。例如：若流年地支为喜用神，则当年有好的根基支持。】

---
* **【每日分析统一规则 (适用于周一至周日)】**

    * **1. 生成标题行，格式为：`**X月X日 周X 干支日(五行属性, 特殊关系) -【运势关键词】**`**
        * **A. 括号内容生成规则：**
            * **五行属性:** 首先，根据当日“干支”的五行，提炼出当日主导的能量，如“己酉”提炼为“土金旺”，“壬子”提炼为“水旺”，“癸丑”因丑中藏干复杂，可提炼为“水土杂”。
            * **特殊关系 (可选):** 接着，检查当日地支与“月支”（午）或“年支”（巳）有无关键的“刑、冲、合、破”等关系。若有，则在五行属性后追加，如庚戌日的“午戌半合”，可标注为“(土金旺, 合火)”；壬子日的“子午冲”，可标注为“(水旺, 子午冲)”。若无特别突出的关系，则此项可省略。
        * **B. 运势关键词生成规则：**
            * 综合当日干支的喜忌、以及与命主八字的相互作用，给出一个高度概括的、1-4字的定性词，如【本周最佳日】、【压力高峰】、【平稳开启】等。

    * **2. 编写“分析”内容：**
        * 【规则：将当日的流日天干地支与命主的“喜忌神”进行详细比对。首先解释此干支对命主有利或不利的根本原因（例如：己土是你的喜神...）。然后，深入分析此干支与命主“四柱”八字之间产生的具体刑、冲、合、害等关系，并解释这些关系在现实生活中可能对应的具体事件意象。】

    * **3. 编写“建议”内容：**
        * 【规则：基于“分析”部分得出的结论，提供具体、清晰、可操作的行为指导。如果当天是吉日，应鼓励命主抓住机遇，指明适合做什么（例如：适合协作、推进项目）。如果当天是凶日，应明确提醒命主规避风险，并给出具体的规避方法（例如：避免冲动、谨慎做决定、注意人际关系等）。】

---

#### **总结展望**

* **本周运势:**
    * 【规则：综合一周七天的每日分析，概括本周运势的整体趋势和节奏，例如：“先高后低，机遇与挑战并存”、“整体平稳，稳中有升”或“一波三折，需步步为营”等。】

* **关键事件:**
    * 【规则：提炼出本周最重要的几点建议。明确指出哪几天是机遇期（通常是喜用神日），应如何把握；哪几天是风险期（通常是忌神日或发生刑冲的日子），应如何规避和调整。】


【规则：此处无标题字段，直接一句话概括本周到下周的运势变化。具体规则是对比本周的五行能量与下周的五行能量，基于命主的喜忌，判断运势是延续、转好还是变差，给出一个具有前瞻性和预警性的结论，帮助命主提前做好心理和行动上的准备。示例概括：
 > **“请务必熬过本周末木元素带来的高压与郁闷，因为下周将迎来“触底反弹”的强力逆转，周一至周四是你近期能量最顺、机遇最佳的黄金支援期。”**
】


## 背景补充

### 日期信息
当下是：{nowtime}（6月9日周一-乙巳年壬午月十四，我需要通过代码库计算拼接字符输出乙巳年壬午月植入到这里，这样避免大模型转换）
未来两周日历：{calendar}（这部分也是能通过代码计算出来，就往里面拼接，实在无法获取的准确数据才让大模型来分析）


### 命主信息
- 名字
{name}
- 性别
{sex}
- 胎身命
{isTai}
- 真太阳时生辰
{birth}
- 当前所在城市
{city}
- 四柱
{bazi}
- 大运
> 起运：出生后{dayun_time}上大运
> 交运：逢{jiaoyun_time} 交大运



# 示例报告
### **小刘专属五行能量周报 (6.9 - 6.15)**

---

#### **命盘解读**

* **日主 :** 你是 ⛰️**戊土** 日主。戊土的特性是沉稳、厚重、讲信用，如大地山峦，有承载万物的能力。

* **命盘格局:** 你的八字 **己卯 乙亥 戊寅 癸亥**，全局水木（财星和官杀）极旺，而生助你的火土力量很弱。这属于典型的 **身弱财官旺** 格局。
    * **身弱:** 意味着你需要能量来生助你、支撑你，才能担得起八字里旺盛的“财富”（水）和“事业/压力”（木）。
    * **财官旺:** 意味着你天生就面临着许多机遇（财）和责任/挑战（官），潜力巨大，但需要有足够的力量去驾驭它们。

* **喜用神:**
    * **最喜：火🔥**。火是你的“印星”，能生助戊土，给你带来能量、支持、贵人、学习和温暖，是你最重要的“充电宝”。(你反馈的周二极顺的体验，以及体检顺利，都强力印证了火元素对你的重要性。)
    * **次喜：土⛰️**。土是你的“比劫”，能直接帮你分担压力，代表朋友、同事、合作伙伴的支持。

* **忌神:**
    * **最忌：木🌳**。木（官杀）在你的命盘里已经过旺，再来木会加剧你的压力、工作量、紧张感和人际关系中的制约。
    * **次忌：水💧**。水（财星）会生旺木，同时消耗你的能量，让你感到劳累。虽然代表财，但水太多时，是“富屋贫人”，难以承受。


---

#### **流日分析**

**当下大环境：** 乙巳年，壬午月。
对你来说，**巳年**和**午月**的**火**是你最需要的能量，这是大环境给你的强力支持，能让你更有精力、更有贵人运。但**乙木**和**壬水**是忌神，意味着机遇中依然伴随着压力和消耗。

---

**6.9 周一 己酉日(土金旺) -【平稳开启】**
* **分析:** 己土是你的喜神（劫财），能给你带来支持。但酉金会与你年柱的卯木形成“卯酉冲”，可能会带来一些计划外的微小变动或与远方、长辈相关的波动。
* **建议:** 整体平稳。适合与朋友、同事协作，能获得实际帮助。注意保持灵活，应对小变化。

**6.10 周二 庚戌日(土金旺, 合火) -【本周最佳日】**
* **分析:** 戌土是你的喜神，是强根。更重要的是，月支午与日支戌形成“午戌半合火局”，大大增强了你最需要的**火**（印星）的能量！这是对你最有利的一天。
* **建议:** **这是你的“黄金行动日”！**精力充沛，思路清晰，贵人运强。务必把握这类日子推进重要事项。

**6.11 周三 辛亥日(金水旺) -【能量下滑】**
* **分析:** 亥水是你的忌神（偏财），加剧了你命盘中本已过旺的水。水多木漂，水多土荡，你的能量会被严重消耗。
* **建议:** 这是消耗较大的一天。容易感到疲惫、情绪化，或在财务上有些预料外的开销。**宜静不宜动**，做好分内事即可，避免安排重要和劳累的活动。

**6.12 周四 壬子日(水旺, 子午冲) -【压力高峰】**
* **分析:** 壬水、子水均为你的忌神，水能量达到顶峰。日支子水与月支午火形成“子午冲”，把你最需要的“火”冲散了。这是对你**最不利**的一天。
* **建议:** **高度注意！**情绪起伏会非常大，容易与人发生冲突，尤其是在工作或亲密关系中。内心容易烦躁不安，避免做任何冲动的决定。保持独处，听听音乐，做一些能让自己平静下来的事情。

**6.13 周五 癸丑日(水土杂) -【谨慎行事】**
* **分析:** 癸水是忌神，但丑土是喜神。癸水与你的日主“戊癸合”，有被事情或关系牵绊住的象，但好在有丑土的根基支持，不至于完全失控。水土混杂确实容易让人思路不清。
* **建议:** 运势好转，但依然混乱。处理事务时务必放慢速度，反复确认，尤其涉及文书、合同和财务。不要凭感觉做决定，多听听可靠朋友的意见。

**6.14 周六 甲寅日(木旺, 相刑) -【压力再临】**
* **分析:** 甲木、寅木都是你的忌神（七杀），会给你带来极大的压力、挑战和紧张感。同时，流年巳、日支寅、你命中的寅形成“寅巳刑”，加强了这种不顺感。
* **建议:** 重点关注人际关系和健康。容易感到被压迫、被挑战，或者遇到棘手的人和事。开车出行注意交通安全。避免与人争执，宜多做运动或体力活动来释放压力。

**6.15 周日 乙卯日(木旺, 相破) -【持续承压】**
* **分析:** 乙木、卯木又是你的忌神（正官），压力持续。虽然是正官，相对温和，但身弱不喜官杀，依然会感到被约束、工作量大、心情不畅。
* **建议:** 周末也难以放松的一天。可能需要处理工作或家庭的责任。利于完成计划内的任务，不适合开启新事务。



---

### **流日分析 (最终精炼版)**

**当下大环境：** 乙巳年，壬午月。火旺的年月，对你有利。但乙木、壬水为忌，机遇与压力并存。

---

**6.9 周一 己酉日(土金旺) -【平稳开启】**
* **分析:** 喜神己土提供同辈支持。但卯酉冲，可能引发与远方或长辈相关的微小变动。
* **建议:** 适合团队协作。保持灵活，应对计划外变动。

**6.10 周二 庚戌日(土金旺, 合火) -【本周最佳日】**
* **分析:** 戌土为强根，且午戌合火，引动最强喜神“印星”。能量达到本周顶峰。
* **建议:** **黄金行动日**。全力推进重要项目、会议、决策，事半功倍。

**6.11 周三 辛亥日(金水旺) -【能量下滑】**
* **分析:** 忌神金水转旺，消耗自身能量，且削弱大环境的火。
* **建议:** 能量消耗大，易疲惫、情绪化。宜静不宜动，做好分内事。

**6.12 周四 壬子日(水旺, 子午冲) -【压力高峰】**
* **分析:** 忌神水能量达顶峰，且子午冲，冲散最需要的火。这是本周**最不利**的一天。
* **建议:** **高度注意**。情绪易失控，避免冲突和冲动决定。宜独处，求稳。

**6.13 周五 癸丑日(水土杂) -【谨慎行事】**
* **分析:** 水土混杂，能量场不清。癸水合身有牵绊，丑土为喜神有支撑。
* **建议:** 思路易混乱。处理事务须反复确认，尤其涉及文书、财务，勿凭感觉。

**6.14 周六 甲寅日(木旺, 相刑) -【压力再临】**
* **分析:** 强力忌神“七杀”木主导，压力和挑战剧增。寅巳相刑，加剧不顺。
* **建议:** 需注意人际、健康、交通。易感被压迫，避免争执，适合运动解压。

**6.15 周日 乙卯日(木旺, 相破) -【持续承压】**
* **分析:** 忌神“正官”木主导，多为工作和家庭责任带来的约束感。午卯破，好事多磨。
* **建议:** 周末难放松。适合完成计划内任务，不宜开启新事务。
---
#### **第三部分：本周总结与下周展望**

* **本周总体运势:** **先扬后抑，机遇与压力并存的一周。**周二的黄金日为你提供了宝贵的行动窗口，但周三之后运势急转直下，压力、消耗和情绪波动成为后半周的主题。

* **核心注意事项:**
    1.  **抓住机遇日 (周二):** 你已成功利用。未来遇到火土旺的日子，都应如此重点规划。
    2.  **规避风险日 (周四):** 关键在于情绪管理和避免冲突。
    3.  **管理压力期 (周六、日):** 周末木旺，压力倍增，提前规划好放松活动，或将精力用于处理积压的任务，避免将压力带入下周。

* **一句话概括本周到下周的变化 (预警与展望):**

    > **“请务必熬过本周末木元素带来的高压与郁闷，因为下周将迎来“触底反弹”的强力逆转，周一至周四是你近期能量最顺、机遇最佳的黄金支援期。”**

    * **解读:** 下周开局（周一至周四）能量极佳，是连续四天的火土喜神，与本周末的压抑感形成鲜明对比。请利用本周末养精蓄锐，为下周的“王炸开局”做好准备，届时是你推进重要事务、扭转局面的绝佳时机。

# 开发清单

### 项目结构
1. 传统表单模式
2. agentic模式
```
zhoubazi/
├── main.py          # 主入口，处理用户输入和流程控制
├── bazi_engine.py   # 命理计算引擎，包含所有历法和八字计算逻辑
├── context.py       # 上下文构建，将计算结果组装为分析所需格式
├── llm_service.py   # 大模型交互，管理提示模板和LLM调用
└── schemas.py       # 数据模型定义，使用Pydantic进行数据验证
```

1. **数据模型定义 (schemas.py)**
   - 用户输入模型：姓名、性别、出生时间、地点
   - 八字结果模型：四柱、五行属性、大运信息
   - 分析上下文模型：所有提交给LLM的数据

2. **命理计算引擎 (bazi_engine.py)**
   - 天干地支和五行基础数据表
   - 公历转农历转换功能
   - 四柱八字计算方法
   - 大运计算方法
   - 当前时间信息生成

3. **上下文构建 (context.py)**
   - 集成计算结果
   - 构建完整分析所需数据
   - 格式化为LLM所需的上下文

4. **大模型服务 (llm_service.py)**
   - 提示模板定义
   - LLM调用接口(流式和非流式)
   - 响应处理

5. **主程序 (main.py)**
   - 用户输入处理
   - 调用计算引擎
   - 构建上下文
   - 调用LLM服务
   - 返回结果

---

#### **第一阶段：环境配置与核心依赖**

* **任务1：项目初始化**
    * [ ] 创建一个新的项目文件夹。
    * [ ] 在项目内创建并激活Python虚拟环境 (`python -m venv venv`)。
    * [ ] 安装核心依赖库：
        * `pip install langchain langchain-google-genai` (或 `langchain-openai` 等)
        * `pip install sxtwl` (寿星天文历，这是所有计算的基石)
        * `pip install python-dotenv` (用于安全管理API密钥)
    * [ ] 创建 `.env` 文件，用于存放你的大模型API密钥 (例如 `GOOGLE_API_KEY=...`)。

#### **第二阶段：核心计算工具函数开发 (原子能力)**

这是项目的核心，目标是为Prompt中的每一个变量，创建一个独立的、可测试的计算函数。

* **任务2：地理位置经度转换工具**
    * **函数名建议：** `get_longitude(city_name: str) -> float`
    * **功能描述：** 输入一个城市名（如“成都”），输出其对应的经度。这是计算真太阳时的前置条件。
    * **实现要点：** 可以内嵌一个简易的城市经度字典，或为了更广泛的适用性，调用一个无需API Key的地理信息查询库。对于开源项目，建议先从一个内置的常用城市字典开始。

* **任务3：真太阳时计算工具**
    * **函数名建议：** `calculate_true_solar_time(gregorian_dt: datetime, longitude: float) -> datetime`
    * **功能描述：** 输入公历日期时间对象和经度，输出校准后的真太阳时日期时间对象。
    * **实现要点：** 使用 `sxtwl` 库提供的功能来完成计算。

* **任务4：四柱排盘工具**
    * **函数名建议：** `get_bazi_pillars(true_solar_dt: datetime) -> list`
    * **功能描述：** 输入真太阳时，输出包含年、月、日、时四柱天干地支的列表。
    * **实现要点：** 调用 `sxtwl` 库，从时间对象中提取四柱信息。
    * **输出示例：** `['己卯', '乙亥', '戊寅', '癸亥']`

* **任务5：大运信息计算工具**
    * **函数名建议：** `get_dayun_info(true_solar_dt: datetime, gender: str) -> dict`
    * **功能描述：** 输入真太阳时和性别，计算起运时间和交运年份规律。
    * **实现要点：** 使用 `sxtwl` 库计算起运的具体年月日（`dayun_time`）和交运年份的天干规律（`jiaoyun_time`）。
    * **输出示例：** `{ "dayun_time": "5年0月0日0时", "jiaoyun_time": "甲、己年" }`

* **任务6：高级命盘信息计算工具 (胎元、命宫、身宫)**
    * **函数名建议：** `get_advanced_info(bazi_pillars: list) -> str`
    * **功能描述：** 根据四柱信息，计算胎元、命宫、身宫。
    * **实现要点：**
        * 胎元：根据月柱推算（月干进一位，月支进三位）。
        * 命宫、身宫：可使用 `sxtwl` 库的对应功能进行计算。
        * 将三者拼接成一个字符串。
    * **输出示例：** `"胎元：丙寅 命宫：癸酉 身宫：乙亥"`

* **任务7：当前时间格式化工具**
    * **函数名建议：** `get_formatted_now_time() -> str`
    * **功能描述：** 获取当前系统时间，并格式化为Prompt中需要的完整中文字符串。
    * **实现要点：** 使用 `datetime.now()` 获取时间，再用 `sxtwl` 将其转换为干支纪年、纪月、纪日，并结合农历日期和星期。
    * **输出示例：** `"乙巳年壬午月XX日 周X 农历XX月XX"`

* **任务8：未来日历生成工具**
    * **函数名建议：** `get_future_calendar(days: int = 14) -> str`
    * **功能描述：** 生成从当天算起，未来N天（默认14天）的日历字符串。
    * **实现要点：** 循环N次，每次计算当天的公历日期、星期、干支日和农历日期，然后拼接成一个多行字符串。
    * **输出示例：**
        ```
        6月9日 周一 己酉日 (农历五月十四)
        6月10日 周二 庚戌日 (农历五月十五)
        ...
        ```

#### **第三阶段：整合与调用 (Orchestration & Invocation)**

* **任务9：构建Prompt填充字典**
    * **函数名建议：** `build_prompt_variables(name, sex, birth_dt_str, is_lunar, birth_city, current_city)`
    * **功能描述：** 这是总调度函数。它接收最原始的用户输入，依次调用第二阶段的所有工具函数，收集计算结果，并组装成一个字典，键名与Prompt模板中的变量名完全对应。
    * **实现要点：** 这是整个流程的粘合剂，确保数据流的正确传递。

* **任务10：定义LangChain链**
    * **目标：** 将Prompt模板、大模型和输出解析器连接起来。
    * **实现要点：**
        1.  使用 `langchain.prompts.PromptTemplate` 从一个字符串文件加载你的Prompt模板。
        2.  初始化大模型，例如 `ChatGoogleGenerativeAI(model="gemini-pro", streaming=True)`。
        3.  使用LangChain表达式语言(LCEL)构建链：`chain = prompt_template | llm | StrOutputParser()`。

* **任务11：创建主调用接口**
    * **函数名建议：** `get_bazi_report_stream(name, sex, birth_dt_str, ...)`
    * **功能描述：** 这是整个项目的最终入口函数。
    * **实现要点：**
        1.  调用 **任务9** 的 `build_prompt_variables` 函数，获得填充好所有变量的字典。
        2.  调用 **任务10** 创建的 `chain` 的 `.stream()` 方法，并将上一步的字典作为输入。
        3.  `return` 这个流式响应的生成器。外部调用者可以直接 `for chunk in get_bazi_report_stream(...)` 来获取结果。




# end